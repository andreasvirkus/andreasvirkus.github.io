<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Appending lines to XML</title>
    <meta name="description" content="Showing how to easily append lines at the end of an XML file (like your sitemap).">
    <link rel="stylesheet" href="/css/prism-tomorrow.css">
    <link rel="stylesheet" href="/css/theme.css">
    <link rel="alternate" href="/feed/feed.xml" type="application/atom+xml" title="ajv | Cottage">

    <style>
    /* TODO: Add "ciritcal skeleton" and fade in content from it? */
    ::selection {
      background-color: #a29bfe;
      color: #fff;
    }

    .theme-container {
      display: flex;
      min-height: 100vh;
      flex-direction: column;
      background-color: var(--bg-light);
      margin: var(--bg-border);
    }
    </style>

  </head>
  <body class="theme-container">
    <header>
      <!-- Search box -->
      <h1 class="home">
        <a href="/">ajv | Cottage</a>
      </h1>

      <!-- Side bar -->
      <ul class="nav"><li class="nav-item"><a href="/thoughts/"></a></li><li class="nav-item"><a href="/"></a></li><li class="nav-item"><a href="/contact/"></a></li><li class="nav-item"><a href="/about/"></a></li></ul>
    </header>

    <!-- TODO: Display latest posts? -->

    <main class="post">
      
<h1>Appending lines to XML</h1>

<p>So I faced an interesting problem the other day, where<br>
I discovered my CV's downloadable PDF link isn't indexed (aka included in my<br>
<code>sitemap.xml</code> file). And it <a href="https://www.thewebmaster.com/seo/2016/feb/24/google-we-index-pdfs-just-like-any-other-web-page/">should be</a>. So we've established that PDFs should end up in our sitemap.</p>
<p>To achieve that, I'll run you through a snippet to append it as an entry to the sitemap.<br>
The way we'll go through this is first set up a basic working node module and<br>
then later (maybe?) also turn it into a Metalsmith plugin (WIP).</p>
<p>We'll need Node's native <code>fs</code> and <code>path</code> modules and also the file's name<br>
(which you can later make dynamic, but currently we'll settle for the default<br>
<code>sitemap.xml</code> value).</p>
<pre class="language-js"><code class="language-js"><span class="highlight-line"><span class="token keyword">const</span> fs <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'fs'</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span><br><span class="highlight-line"><span class="token keyword">const</span> path <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'path'</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span><br><span class="highlight-line"><span class="token keyword">const</span> fileName <span class="token operator">=</span> <span class="token string">'sitemap.xml'</span><span class="token punctuation">;</span></span></code></pre>
<p>Next we'll define the sitemap's closing tag, so we could replace the length of it<br>
when we write to the file later (you'll hear more 'bout it in a bit).</p>
<pre class="language-js"><code class="language-js"><span class="highlight-line"><span class="token keyword">const</span> closingTag <span class="token operator">=</span> <span class="token string">'&lt;/urlset>'</span><span class="token punctuation">;</span></span></code></pre>
<p>Then we'll go ahead and create a buffer containing our new content (the line<br>
we're appending) and the closing tag we just defined<br>
...aand also need to know the file's path and size.</p>
<pre class="language-js"><code class="language-js"><span class="highlight-line"><span class="token keyword">let</span> content <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">&lt;url> &lt;loc>https://andreasvirkus.me/assets/cv/CV-Andreas-Johan-Virkus.pdf&lt;/loc> &lt;/url></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span></span><br><span class="highlight-line">    buffer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Buffer</span><span class="token punctuation">(</span>content<span class="token operator">+</span> <span class="token string">'\n'</span> <span class="token operator">+</span> closingTag<span class="token punctuation">)</span><span class="token punctuation">,</span></span><br><span class="highlight-line">    filePath <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">'..'</span><span class="token punctuation">,</span> <span class="token string">'dist'</span><span class="token punctuation">,</span> fileName<span class="token punctuation">)</span><span class="token punctuation">,</span></span><br><span class="highlight-line">    fileSize <span class="token operator">=</span> fs<span class="token punctuation">.</span><span class="token function">statSync</span><span class="token punctuation">(</span>filePath<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token string">'size'</span><span class="token punctuation">]</span><span class="token punctuation">;</span></span></code></pre>
<p>Now all that's left to do is to open up the <code>XML</code> file and replace the<br>
end of the file (length of the closing tag) with our freshly defined buffer:</p>
<pre class="language-js"><code class="language-js"><span class="highlight-line">fs<span class="token punctuation">.</span><span class="token function">open</span><span class="token punctuation">(</span>filePath<span class="token punctuation">,</span> <span class="token string">'r+'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">,</span> fd</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span></span><br><span class="highlight-line">    <span class="token comment">// File was most likely not found or we don't have permission to write</span></span><br><span class="highlight-line">    <span class="token keyword">if</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token keyword">throw</span> err<span class="token punctuation">;</span></span><br><span class="highlight-line"></span><br><span class="highlight-line">    fs<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> buffer<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> buffer<span class="token punctuation">.</span>length<span class="token punctuation">,</span> fileSize <span class="token operator">-</span> closingTag<span class="token punctuation">.</span>length<span class="token punctuation">,</span> <span class="token parameter">err</span> <span class="token operator">=></span> <span class="token punctuation">{</span></span><br><span class="highlight-line">        <span class="token keyword">if</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token keyword">throw</span> err<span class="token punctuation">;</span></span><br><span class="highlight-line">    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span><br><span class="highlight-line"><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span></code></pre>
<p>So what we've got so far is this:</p>
<pre class="language-js"><code class="language-js"><span class="highlight-line"><span class="token comment">// appendToSitemap.js</span></span><br><span class="highlight-line"></span><br><span class="highlight-line"><span class="token keyword">const</span> fs <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'fs'</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span><br><span class="highlight-line"><span class="token keyword">const</span> path <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'path'</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span><br><span class="highlight-line"><span class="token keyword">const</span> fileName <span class="token operator">=</span> <span class="token string">'sitemap.xml'</span><span class="token punctuation">;</span></span><br><span class="highlight-line"><span class="token keyword">const</span> closingTag <span class="token operator">=</span> <span class="token string">'&lt;/urlset>'</span><span class="token punctuation">;</span></span><br><span class="highlight-line"></span><br><span class="highlight-line"><span class="token keyword">let</span> content <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">&lt;url> &lt;loc>https://andreasvirkus.me/assets/cv/CV-Andreas-Johan-Virkus.pdf&lt;/loc> &lt;/url></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span></span><br><span class="highlight-line">    buffer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Buffer</span><span class="token punctuation">(</span>content<span class="token operator">+</span> <span class="token string">'\n'</span> <span class="token operator">+</span> closingTag<span class="token punctuation">)</span><span class="token punctuation">,</span></span><br><span class="highlight-line">    filePath <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">'..'</span><span class="token punctuation">,</span> <span class="token string">'dist'</span><span class="token punctuation">,</span> fileName<span class="token punctuation">)</span><span class="token punctuation">,</span></span><br><span class="highlight-line">    fileSize <span class="token operator">=</span> fs<span class="token punctuation">.</span><span class="token function">statSync</span><span class="token punctuation">(</span>filePath<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token string">'size'</span><span class="token punctuation">]</span><span class="token punctuation">;</span></span><br><span class="highlight-line"></span><br><span class="highlight-line">fs<span class="token punctuation">.</span><span class="token function">open</span><span class="token punctuation">(</span>filePath<span class="token punctuation">,</span> <span class="token string">'r+'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">,</span> fd</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span></span><br><span class="highlight-line">    fs<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> buffer<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> buffer<span class="token punctuation">.</span>length<span class="token punctuation">,</span> fileSize <span class="token operator">-</span> closingTag<span class="token punctuation">.</span>length<span class="token punctuation">,</span> <span class="token parameter">err</span> <span class="token operator">=></span> <span class="token punctuation">{</span></span><br><span class="highlight-line">        <span class="token keyword">if</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token keyword">throw</span> err<span class="token punctuation">;</span></span><br><span class="highlight-line">    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span><br><span class="highlight-line"><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span></code></pre>
<p>Now we can run it as any other Node script: <code>node appendToSitemap.js</code> and<br>
it should add our <code>content</code> variable as the last entry of the file's <code>urlset</code>.</p>
<p>Since I wish to automate this process, I'll add it to my Metalsmith<br>
build's callback as a module:</p>
<pre class="language-js"><code class="language-js"><span class="highlight-line"><span class="token keyword">const</span> fs <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'fs'</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span><br><span class="highlight-line"><span class="token keyword">const</span> path <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'path'</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span><br><span class="highlight-line"><span class="token keyword">const</span> fileName <span class="token operator">=</span> <span class="token string">'sitemap.xml'</span><span class="token punctuation">;</span></span><br><span class="highlight-line"><span class="token keyword">const</span> closingTag <span class="token operator">=</span> <span class="token string">'&lt;/urlset>'</span><span class="token punctuation">;</span></span><br><span class="highlight-line"></span><br><span class="highlight-line">module<span class="token punctuation">.</span><span class="token function-variable function">exports</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">content</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span><br><span class="highlight-line">    <span class="token keyword">let</span> buffer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Buffer</span><span class="token punctuation">(</span>content<span class="token operator">+</span> <span class="token string">'\n'</span> <span class="token operator">+</span> closingTag<span class="token punctuation">)</span><span class="token punctuation">,</span></span><br><span class="highlight-line">        filePath <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">'..'</span><span class="token punctuation">,</span> <span class="token string">'dist'</span><span class="token punctuation">,</span> fileName<span class="token punctuation">)</span><span class="token punctuation">,</span></span><br><span class="highlight-line">        fileSize <span class="token operator">=</span> fs<span class="token punctuation">.</span><span class="token function">statSync</span><span class="token punctuation">(</span>filePath<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token string">'size'</span><span class="token punctuation">]</span><span class="token punctuation">;</span></span><br><span class="highlight-line"></span><br><span class="highlight-line">    fs<span class="token punctuation">.</span><span class="token function">open</span><span class="token punctuation">(</span>filePath<span class="token punctuation">,</span> <span class="token string">'r+'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">,</span> fd</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span></span><br><span class="highlight-line">        fs<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> buffer<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> buffer<span class="token punctuation">.</span>length<span class="token punctuation">,</span> fileSize <span class="token operator">-</span> closingTag<span class="token punctuation">.</span>length<span class="token punctuation">,</span> <span class="token parameter">err</span> <span class="token operator">=></span> <span class="token punctuation">{</span></span><br><span class="highlight-line">            <span class="token keyword">if</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token keyword">throw</span> err<span class="token punctuation">;</span></span><br><span class="highlight-line">        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span><br><span class="highlight-line">    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span><br><span class="highlight-line"><span class="token punctuation">}</span><span class="token punctuation">;</span></span></code></pre>
<p>And I can call it in my <code>build.js</code> file:</p>
<pre class="language-js"><code class="language-js"><span class="highlight-line"><span class="token function">metalsmith</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">)</span></span><br><span class="highlight-line">    <span class="token punctuation">.</span><span class="token function">source</span><span class="token punctuation">(</span><span class="token string">'./src'</span><span class="token punctuation">)</span></span><br><span class="highlight-line">    <span class="token punctuation">.</span><span class="token function">destination</span><span class="token punctuation">(</span><span class="token string">'./dist'</span><span class="token punctuation">)</span></span><br><span class="highlight-line">    <span class="token punctuation">.</span><span class="token function">clean</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span></span><br>    <span class="token comment">/**<br><span class="highlight-line">     * Using any amount of plugins here</span><br><span class="highlight-line">     * ...</span><br>     */</span>s<br><span class="highlight-line">    <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">err</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span><br><span class="highlight-line">        <span class="token keyword">if</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token keyword">throw</span> err<span class="token punctuation">;</span></span><br><span class="highlight-line"></span><br><span class="highlight-line">        <span class="token comment">// Update sitemap</span></span><br><span class="highlight-line">        <span class="token function">appendToSitemap</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">&lt;url> &lt;loc>https://andreasvirkus.me/assets/cv/CV-Andreas-Johan-Virkus.pdf&lt;/loc> &lt;/url></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span></span><br><span class="highlight-line">    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span></code></pre>


<p><a href="/">← Home</a></p>

    </main>

    <footer class="site-footer">
  <p class="content edit-link">
    <a href="/tree/master/./src/thoughts/appending-lines-to-xml.md"
      target="_blank"
      rel="noopener noreferrer">Help me improve this page</a>
  </p>

  <section class="social">
  <p>Social links</p>
  <ul class="social__list">
    <li class="social__icon" v-for="link in links">
      <a class="social__link fuzzy-interact"
        :href="link.link"
        :title="link.alt"
        v-html="link.icon"
        :rel="link.rel"
        :type="link.type"></a>
    </li>
  </ul>

  <svg class="fuzzy-filters">
    <filter id="turbulence-1">
      <feTurbulence type="fractalNoise" baseFrequency="0.01" numOctaves="3" />
      <feDisplacementMap xChannelSelector="R" yChannelSelector="G" in="SourceGraphic" scale="5" />
    </filter>

    <filter id="turbulence-2">
      <feTurbulence type="fractalNoise" baseFrequency="0.015" numOctaves="3" />
      <feDisplacementMap xChannelSelector="R" yChannelSelector="G" in="SourceGraphic" scale="7" />
    </filter>

    <filter id="turbulence-3">
      <feTurbulence type="fractalNoise" baseFrequency="0.02" numOctaves="3" />
      <feDisplacementMap xChannelSelector="R" yChannelSelector="G" in="SourceGraphic" scale="5" />
    </filter>

    <filter id="turbulence-4">
      <feTurbulence type="fractalNoise" baseFrequency="0.025" numOctaves="3" />
      <feDisplacementMap xChannelSelector="R" yChannelSelector="G" in="SourceGraphic" scale="4" />
    </filter>

    <filter id="turbulence-5">
      <feTurbulence type="fractalNoise" baseFrequency="0.03" numOctaves="3" />
      <feDisplacementMap xChannelSelector="R" yChannelSelector="G" in="SourceGraphic" scale="3" />
    </filter>
  </svg>
</section>

  <p>Proudly generated with
    <a :href="$site.themeConfig.generatorUrl"
      :title="$site.themeConfig.generatorTitle"
      ></a>,
  </p>
  <p>safely hosted on
    <a :href="$site.themeConfig.hostUrl"
      :title="$site.themeConfig.hostTitle"
      ></a>.
  </p>
</footer>


    <!-- Current page: /thoughts/appending-lines-to-xml/ -->
  </body>
</html>
